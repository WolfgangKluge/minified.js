/**
 * JavaScript preprocessor for Ant+Rhino that merges JavaScript files.
 * 
 * Syntax:
 * In input file, there can be statements 
 *    ///#include filename snippetname
 * To include a snippet from a file (relative to bath path).
 * 
 * Snippets in the input file can be removed using
 *    ///#remove
 *      .. block to remove ..
 *    ///#/remove
 *    
 * The included files must declare snippets like this:
 *    ///#snippet snippetname
 *     ... code to include ...
 *    ///#/snippet 
 */

// Helper

// read file from path into string
function readFile(file) {
	return ''+new String(org.apache.tools.ant.util.FileUtils.readFully(new java.io.FileReader(file)));
}

// write string into file
function writeFile(file, content) {
	var writer = new java.io.FileWriter(file);
	writer.write(content);
	writer.close();
}

// GO!

eval(readFile('src/minified-util-src.js'));
eval(readFile('build/mergetool.js'));

var _ = (require('minifiedUtil') || require('minified'))._;

var path = project.getProperty('srcPath');
var srcShellName = project.getProperty('srcDblShellName');
var src = readFile(path + srcShellName);

var PROLOG = "\n\n// WARNING! This is an autogenerated file created from " + srcShellName + "\n\n\n"; 



writeFile(path + project.getProperty('srcDblName'), PROLOG + merge(src, function(name) { return readFile(path + name); } ));
